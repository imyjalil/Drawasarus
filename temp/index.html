<!DOCTYPE html>
<html lang=”en”>

<head>
    <meta charset=”UTF-8” />
    <meta name=”viewport” content=”width=device-width, initial-scale=1.0” />
    <title>WebRTC</title>

    <style type=”text/css”>
        body {
            margin: 0;
            font-size: 20px;
        }

        .centered {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .video-position {
            position: absolute;
            top: 35%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #video-chat-container {
            width: 100%;
            background-color: black;
        }

        #local-video {
            position: absolute;
            height: 30%;
            width: 30%;
            bottom: 0px;
            left: 0px;
        }

        #remote-video {
            height: 100%;
            width: 100%;
        }
    </style>




</head>

<body>
    <div id=room-selection-container class="centered">
        <h1>WebRTC video conference</h1>
        <label>Enter the number of the room you want to connect</label>
        <input id=room-input type="text" />
        <button id=connect-button>CONNECT</button>
    </div>

    <div id=video-chat-container class="video-position" style="display: none">
        <video id=local-video autoplay="autoplay" disabled></video>
        <video id=remote-video autoplay="autoplay"></video>
    </div>

    <div>
        <button onclick="stop()">stop</button>
        <button onclick="resume()">resume</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>

    <script>

        let isRoomCreator;

        let localStream
        let remoteStream
        let rtcPeerConnection // Connection between the local device and the remote peer.
        let roomId

        const iceServers = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' },
            ],
        }

        const socket = io("ws://localhost:3000/");

        const mediaConstraints = {
            audio: true,
            video: false
        }

        // const mediaConstraints = {
        //     audio: true,
        //     video: { width: 1280, height: 720 },
        // }

        const roomSelectionContainer = document.getElementById('room-selection-container')
        const roomInput = document.getElementById('room-input')
        const connectButton = document.getElementById('connect-button')

        const videoChatContainer = document.getElementById('video-chat-container')
        const remoteVideoComponent = document.getElementById('remote-video')

        console.log("socket", socket)

        function stop() {
            console.log("inside the stop")
            remoteStream.getAudioTracks()[0].enabled = false;
        }

        function resume() {
            remoteStream.getAudioTracks()[0].enabled = true;
        }


        function joinRoom(room) {

            if (room === '') {
                alert('Please type a room ID')
            } else {
                roomId = room
                socket.emit('join', room)
                showVideoConference()
            }
        }

        function showVideoConference() {
            roomSelectionContainer.style = 'display: none'
            videoChatContainer.style = 'display: block'
        }

        connectButton.addEventListener('click', () => {
            joinRoom(roomInput.value)
        })

        // FUNCTIONS ==================================================================


        // SOCKET EVENT CALLBACKS =====================================================
        socket.on('room_created', async () => {
            console.log('Socket event callback: room_created')

            await setLocalStream(mediaConstraints)
            isRoomCreator = true
        })

        socket.on('room_joined', async () => {
            console.log('Socket event callback: room_joined')

            await setLocalStream(mediaConstraints)
            socket.emit('start_call', roomId)
        })


        socket.on('webrtc_ice_candidate', (event) => {
            console.log('Socket event callback: webrtc_ice_candidate')

            // ICE candidate configuration.
            var candidate = new RTCIceCandidate({
                sdpMLineIndex: event.label,
                candidate: event.candidate,
            })
            rtcPeerConnection.addIceCandidate(candidate)
        })

        function offerCreation(rtcPeerConnection) {

              if (isRoomCreator) {
                addLocalTracks(rtcPeerConnection)
                rtcPeerConnection.ontrack = setRemoteStream
                rtcPeerConnection.onicecandidate = sendIceCandidate
                await createOffer(rtcPeerConnection)
            }
        }

        socket.on('start_call', async () => {
            console.log('Socket event callback: start_call')
            
            rtcPeerConnection[clientID] = new RTCPeerConnection(iceServers)
          
        })

        socket.on('webrtc_answer', (event) => {
            console.log('Socket event callback: webrtc_answer')

            rtcPeerConnection.setRemoteDescription(new RTCSessionDescription(event))
        })


        socket.on('webrtc_offer', async (event) => {
            console.log('Socket event callback: webrtc_offer')

            if (!isRoomCreator) {
                rtcPeerConnection = new RTCPeerConnection(iceServers)
                addLocalTracks(rtcPeerConnection)
                rtcPeerConnection.ontrack = setRemoteStream
                rtcPeerConnection.onicecandidate = sendIceCandidate
                rtcPeerConnection.setRemoteDescription(new RTCSessionDescription(event))
                await createAnswer(rtcPeerConnection)
            }
        })

        function setRemoteStream(event) {

            console.log(event)
            console.log("remote stream set", event.stream)
            remoteVideoComponent.srcObject = event.streams[0]
            remoteStream = event.streams[0]
            console.log("remote stream set", remoteStream)
        }

        function sendIceCandidate(event) {
            if (event.candidate) {
                socket.emit('webrtc_ice_candidate', {
                    roomId,
                    label: event.candidate.sdpMLineIndex,
                    candidate: event.candidate.candidate,
                })
            }
        }

        async function createAnswer(rtcPeerConnection) {
            let sessionDescription
            try {
                sessionDescription = await rtcPeerConnection.createAnswer()
                rtcPeerConnection.setLocalDescription(sessionDescription)
            } catch (error) {
                console.error(error)
            }

            socket.emit('webrtc_answer', {
                type: 'webrtc_answer',
                sdp: sessionDescription,
                roomId,
            })
        }


        async function createOffer(rtcPeerConnection) {
            let sessionDescription
            try {
                sessionDescription = await rtcPeerConnection.createOffer()
                rtcPeerConnection.setLocalDescription(sessionDescription)
            } catch (error) {
                console.error(error)
            }

            socket.emit('webrtc_offer', {
                type: 'webrtc_offer',
                sdp: sessionDescription,
                roomId,
            })
        }

        function addLocalTracks(rtcPeerConnection) {
            localStream.getTracks().forEach((track) => {
                rtcPeerConnection.addTrack(track, localStream)
            })
        }

        async function setLocalStream(mediaConstraints) {
            let stream
            try {
                stream = await navigator.mediaDevices.getUserMedia(mediaConstraints)

            } catch (error) {
                console.error('Could not get user media', error)
            }

            localStream = stream
        }


    </script>


</body>

</html>